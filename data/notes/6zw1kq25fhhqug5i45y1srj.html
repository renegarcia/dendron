<h1 id="como-extraer-metadatos-del-volcado-de-una-base-de-datos">Como extraer metadatos del volcado de una base de datos<a aria-hidden="true" class="anchor-heading icon-link" href="#como-extraer-metadatos-del-volcado-de-una-base-de-datos"></a></h1>
<h2 id="resultado">Resultado<a aria-hidden="true" class="anchor-heading icon-link" href="#resultado"></a></h2>
<p><a href="https://renegarcia.github.io/eleventa-db/">Consultar</a> la base de datos Eleventa.</p>
<h2 id="código">Código<a aria-hidden="true" class="anchor-heading icon-link" href="#código"></a></h2>
<p>Primero instalamos el paquete <code>sqlparse</code>. Desde <code>pypy</code>:</p>
<pre class="language-shell"><code class="language-shell">pip <span class="token function">install</span> sqlparse
</code></pre>
<p>Si utlizamos <code>poetry</code>:</p>
<pre class="language-shell"><code class="language-shell">poetry <span class="token function">add</span> sqlparse
</code></pre>
<p>Una vez instalado, en una sesión de <code>python</code> lo podemos importar de la manera usual</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional
<span class="token keyword">from</span> sqlparse<span class="token punctuation">.</span>sql <span class="token keyword">import</span> Statement
<span class="token keyword">from</span> sqlparse<span class="token punctuation">.</span>tokens <span class="token keyword">import</span> Keyword
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass
<span class="token keyword">import</span> sqlparse
</code></pre>
<h2 id="extrayendo-el-nombre-de-una-definición-de-tabla">Extrayendo el nombre de una definición de tabla<a aria-hidden="true" class="anchor-heading icon-link" href="#extrayendo-el-nombre-de-una-definición-de-tabla"></a></h2>
<p>Vamos a utilizar el siguiente ejemplo de <code>SQL</code> para aprender a extraer la información que necesitamos</p>
<pre class="language-python"><code class="language-python">TABLE <span class="token operator">=</span> <span class="token triple-quoted-string string">"""CREATE TABLE IF NOT EXISTS MY_TABLE (ID TLLAVE NOT NULL,
    CONSTRAINT PK_MY_TABLE PRIMARY KEY (ID));
"""</span>
</code></pre>
<pre class="language-python"><code class="language-python">parsed <span class="token operator">=</span> sqlparse<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>TABLE<span class="token punctuation">)</span> <span class="token comment"># Devuelve una tupla de statements sql contenidos en la cadena</span>
statement <span class="token operator">=</span> parsed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre>
<pre class="language-python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span>
</code></pre>
<pre><code>CREATE TABLE IF NOT EXISTS MY_TABLE (ID TLLAVE NOT NULL,
    CONSTRAINT PK_MY_TABLE PRIMARY KEY (ID));
</code></pre>
<p><code>statement</code> es una variable tipo <code>Statement</code> que puede ser iterada por medio de índices o ciclos.</p>
<pre class="language-python"><code class="language-python">token <span class="token operator">=</span> statement<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>&#x3C;class 'sqlparse.sql.Statement'> &#x3C;class 'sqlparse.sql.Token'>
</code></pre>
<p>Cada token define dos atributos: <code>value</code> y <code>ttype</code>, sin embargo el parser es flojo, al invocarlo evitará escanear recursivamente la cadena como se puede ver en los siguientes ejemplos.</p>
<pre class="language-python"><code class="language-python"><span class="token comment"># En este caso, el primer token tiene un valor definido y un tipo.</span>
token<span class="token punctuation">.</span>value<span class="token punctuation">,</span> token<span class="token punctuation">.</span>ttype
</code></pre>
<pre><code>('CREATE', Token.Keyword.DDL)
</code></pre>
<pre class="language-python"><code class="language-python"><span class="token comment"># En este ciclo se puede ver que los tokens 11 y 13 no fueron analizados por el parser.</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> token <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">:</span>
    token_type <span class="token operator">=</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>ttype<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token format-spec">2d</span><span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{</span>token<span class="token punctuation">.</span>value<span class="token punctuation">:</span><span class="token format-spec">50</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>token_type<span class="token punctuation">:</span><span class="token format-spec">50</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">type</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

</code></pre>
<pre><code> 1. CREATE                                             Token.Keyword.DDL                                  &#x3C;class 'sqlparse.sql.Token'>
 2.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
 3. TABLE                                              Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
 4.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
 5. IF                                                 Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
 6.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
 7. NOT                                                Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
 8.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
 9. EXISTS                                             Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
10.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
11. MY_TABLE                                           None                                               &#x3C;class 'sqlparse.sql.Identifier'>
12.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
13. (ID TLLAVE NOT NULL,
    CONSTRAINT PK_MY_TABLE PRIMARY KEY (ID)) None                                               &#x3C;class 'sqlparse.sql.Parenthesis'>
14. ;                                                  Token.Punctuation                                  &#x3C;class 'sqlparse.sql.Token'>
</code></pre>
<p>El método <code>Statement.flatten</code> realizará el parseo de la cadena completa, devolviendo los tipos y valores de cada token encontrado.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">for</span> i<span class="token punctuation">,</span> token <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    token_type <span class="token operator">=</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>ttype<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token format-spec">2d</span><span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{</span>token<span class="token punctuation">.</span>value<span class="token punctuation">:</span><span class="token format-spec">50</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>token_type<span class="token punctuation">:</span><span class="token format-spec">50</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">type</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
<pre><code> 1. CREATE                                             Token.Keyword.DDL                                  &#x3C;class 'sqlparse.sql.Token'>
 2.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
 3. TABLE                                              Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
 4.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
 5. IF                                                 Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
 6.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
 7. NOT                                                Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
 8.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
 9. EXISTS                                             Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
10.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
11. MY_TABLE                                           Token.Name                                         &#x3C;class 'sqlparse.sql.Token'>
12.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
13. (                                                  Token.Punctuation                                  &#x3C;class 'sqlparse.sql.Token'>
14. ID                                                 Token.Name                                         &#x3C;class 'sqlparse.sql.Token'>
15.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
16. TLLAVE                                             Token.Name                                         &#x3C;class 'sqlparse.sql.Token'>
17.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
18. NOT NULL                                           Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
19. ,                                                  Token.Punctuation                                  &#x3C;class 'sqlparse.sql.Token'>
20. 
                                                  Token.Text.Whitespace.Newline                      &#x3C;class 'sqlparse.sql.Token'>
21.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
22.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
23.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
24.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
25. CONSTRAINT                                         Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
26.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
27. PK_MY_TABLE                                        Token.Name                                         &#x3C;class 'sqlparse.sql.Token'>
28.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
29. PRIMARY                                            Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
30.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
31. KEY                                                Token.Keyword                                      &#x3C;class 'sqlparse.sql.Token'>
32.                                                    Token.Text.Whitespace                              &#x3C;class 'sqlparse.sql.Token'>
33. (                                                  Token.Punctuation                                  &#x3C;class 'sqlparse.sql.Token'>
34. ID                                                 Token.Name                                         &#x3C;class 'sqlparse.sql.Token'>
35. )                                                  Token.Punctuation                                  &#x3C;class 'sqlparse.sql.Token'>
36. )                                                  Token.Punctuation                                  &#x3C;class 'sqlparse.sql.Token'>
37. ;                                                  Token.Punctuation                                  &#x3C;class 'sqlparse.sql.Token'>
</code></pre>
<h3 id="método-para-obtener-el-nombre-de-la-tabla">Método para obtener el nombre de la tabla<a aria-hidden="true" class="anchor-heading icon-link" href="#método-para-obtener-el-nombre-de-la-tabla"></a></h3>
<p>Las tablas que nos interesa analizar todas tienen siempre la siguiente estructura </p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> my_table_name <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p>por lo que para encontrar el nombre de la tabla necesitamos encontrar el primer token de tipo <code>Identifier</code> que encontnró el parser y extraer su valor, como se ve en el siguiente ejemplo:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">for</span> token <span class="token keyword">in</span> statement<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> sqlparse<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Identifier<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
</code></pre>
<pre><code>MY_TABLE
</code></pre>
<h2 id="extrayendo-una-lista-de-tablas-y-sus-nombres">Extrayendo una lista de tablas y sus nombres<a aria-hidden="true" class="anchor-heading icon-link" href="#extrayendo-una-lista-de-tablas-y-sus-nombres"></a></h2>
<p>El volcado SQL puede tener una mezcla de definiciones de estructuras de datos y otros tipos de código SQL, por ejemplo un query de búsqueda</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> MY_TABLE <span class="token punctuation">(</span>ID TLLAVE <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> PK_MY_TABLE <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>ID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> ANOTHER_TABLE<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> MY_OTHER_TABLE <span class="token punctuation">(</span>ID TLLAVE <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> PK_MY_TABLE <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>ID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>lo que hacemos es utilizar <code>sqlparse</code> para encontrar cada statement y determiar si es de tipo <code>CREATE</code> de modo que para statements de este tipo aplicamos el algoritmo de la sección anterior para encontrar el nombre de la tabla.</p>
<pre class="language-python"><code class="language-python">SQLDUMP <span class="token operator">=</span> <span class="token triple-quoted-string string">"""CREATE TABLE IF NOT EXISTS MY_TABLE (ID TLLAVE NOT NULL,
    CONSTRAINT PK_MY_TABLE PRIMARY KEY (ID));

SELECT * FROM ANOTHER_TABLE;

CREATE TABLE IF NOT EXISTS MY_OTHER_TABLE (ID TLLAVE NOT NULL,
    CONSTRAINT PK_MY_TABLE PRIMARY KEY (ID));
"""</span>

parsed <span class="token operator">=</span> sqlparse<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>SQLDUMP<span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> statement <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>parsed<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{</span>statement<span class="token punctuation">.</span>get_type<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
<pre><code>0. CREATE
1. SELECT
2. CREATE
</code></pre>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_name</span><span class="token punctuation">(</span>statement<span class="token punctuation">:</span> Statement<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> token <span class="token keyword">in</span> statement<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> sqlparse<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Identifier<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> token<span class="token punctuation">.</span>value
    <span class="token keyword">return</span> <span class="token boolean">None</span> 
</code></pre>
<pre class="language-python"><code class="language-python"><span class="token keyword">for</span> i<span class="token punctuation">,</span> statement <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>parsed<span class="token punctuation">)</span><span class="token punctuation">:</span>
    statement_type <span class="token operator">=</span> statement<span class="token punctuation">.</span>get_type<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> statement_type <span class="token operator">==</span> <span class="token string">"CREATE"</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> get_name<span class="token punctuation">(</span>statement<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{</span>statement_type<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
<pre><code>0. CREATE: MY_TABLE
2. CREATE: MY_OTHER_TABLE
</code></pre>
<h3 id="determinando-el-tipo-de-objeto-creado">Determinando el tipo de objeto creado<a aria-hidden="true" class="anchor-heading icon-link" href="#determinando-el-tipo-de-objeto-creado"></a></h3>
<p>En un caso más general, podemos tener volcados sql con varios tipos de objetos, por ejemplo</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> MY_TABLE <span class="token punctuation">(</span>ID <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> MY_INDEX <span class="token keyword">ON</span> MY_TABLE<span class="token punctuation">(</span>ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>analizando los tokens de cada statement es posible determinar el tipo de objeto.</p>
<pre class="language-python"><code class="language-python">SQL <span class="token operator">=</span> <span class="token triple-quoted-string string">"""CREATE TABLE MY_TABLE (ID INTEGER NOT NULL);

SELECT * FROM MY_OTHER_TABLE;

CREATE INDEX MY_INDEX ON MY_TABLE(ID);
"""</span>

parsed <span class="token operator">=</span> sqlparse<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>SQL<span class="token punctuation">)</span>
statement <span class="token operator">=</span> parsed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>


</code></pre>
<pre class="language-python"><code class="language-python">type_found <span class="token operator">=</span> <span class="token boolean">False</span> 
name_found <span class="token operator">=</span> <span class="token boolean">False</span> 
<span class="token keyword">for</span> token <span class="token keyword">in</span> statement<span class="token punctuation">:</span>
    <span class="token keyword">if</span> type_found <span class="token keyword">and</span> name_found<span class="token punctuation">:</span>
        <span class="token keyword">break</span>
    <span class="token keyword">elif</span> token<span class="token punctuation">.</span>ttype <span class="token keyword">is</span> Keyword <span class="token keyword">and</span> <span class="token keyword">not</span> type_found<span class="token punctuation">:</span>
        type_found <span class="token operator">=</span> <span class="token boolean">True</span> 
        token_type <span class="token operator">=</span> token<span class="token punctuation">.</span>value
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> sqlparse<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Identifier<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> name_found<span class="token punctuation">:</span>
        name_found <span class="token operator">=</span> <span class="token boolean">True</span> 
        token_name <span class="token operator">=</span> token<span class="token punctuation">.</span>value
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"tipo: </span><span class="token interpolation"><span class="token punctuation">{</span>token_type<span class="token punctuation">}</span></span><span class="token string">, nombre: </span><span class="token interpolation"><span class="token punctuation">{</span>token_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
<pre><code>tipo: TABLE, nombre: MY_TABLE
</code></pre>
<p>En el código anterior asumimos que todas las cláusulas son simples, es decir del estilo "CREATE ....", si estuvieran agrupadas, por ejemplo "(CREATE ....)" el  algoritmo ya no es tan simple, pues debe de realizar el escaneo de manera recursiva, un ejemplo de este tipo de algoritmo se encuentra en el repositorio de <code>sqlparse</code>:</p>
<p><a href="https://github.com/andialbrecht/sqlparse/blob/master/examples/extract_table_names.py">https://github.com/andialbrecht/sqlparse/blob/master/examples/extract_table_names.py</a></p>
<h3 id="extrayendo-el-nombre-y-tipo-de-objeto-creado-de-un-volcado-completo">Extrayendo el nombre y tipo de objeto creado de un volcado completo<a aria-hidden="true" class="anchor-heading icon-link" href="#extrayendo-el-nombre-y-tipo-de-objeto-creado-de-un-volcado-completo"></a></h3>
<pre class="language-python"><code class="language-python">SQL <span class="token operator">=</span> <span class="token triple-quoted-string string">"""CREATE TABLE MY_TABLE (ID INTEGER NOT NULL);

SELECT * FROM MY_OTHER_TABLE;

CREATE INDEX MY_INDEX ON MY_TABLE(ID);
"""</span>

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">Metadata</span><span class="token punctuation">:</span>
    <span class="token builtin">type</span><span class="token punctuation">:</span> <span class="token builtin">str</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span> 
    
<span class="token keyword">def</span> <span class="token function">get_metadata</span><span class="token punctuation">(</span>statement<span class="token punctuation">:</span> Statement<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Metadata<span class="token punctuation">:</span>
    type_found <span class="token operator">=</span> <span class="token boolean">False</span> 
    name_found <span class="token operator">=</span> <span class="token boolean">False</span> 
    object_name <span class="token operator">=</span> <span class="token boolean">None</span> 
    object_type <span class="token operator">=</span> <span class="token boolean">None</span> 
    <span class="token keyword">for</span> token <span class="token keyword">in</span> statement<span class="token punctuation">:</span>
        <span class="token keyword">if</span> type_found <span class="token keyword">and</span> name_found<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">elif</span> token<span class="token punctuation">.</span>ttype <span class="token keyword">is</span> Keyword <span class="token keyword">and</span> <span class="token keyword">not</span> type_found<span class="token punctuation">:</span>
            type_found <span class="token operator">=</span> <span class="token boolean">True</span> 
            object_type <span class="token operator">=</span> token<span class="token punctuation">.</span>value
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> sqlparse<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Identifier<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> name_found<span class="token punctuation">:</span>
            name_found <span class="token operator">=</span> <span class="token boolean">True</span> 
            object_name <span class="token operator">=</span> token<span class="token punctuation">.</span>value
    <span class="token keyword">return</span> Metadata<span class="token punctuation">(</span>name<span class="token operator">=</span>object_name<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span>object_type<span class="token punctuation">)</span>


parsed <span class="token operator">=</span> sqlparse<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>SQL<span class="token punctuation">)</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> statement <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>parsed<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name_found <span class="token operator">=</span> <span class="token boolean">False</span> 
    <span class="token keyword">if</span> statement<span class="token punctuation">.</span>get_type<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"CREATE"</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    metadata <span class="token operator">=</span> get_metadata<span class="token punctuation">(</span>statement<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span>
</code></pre>
<pre><code>0 Metadata(type='TABLE', name='MY_TABLE')
2 Metadata(type='INDEX', name='MY_INDEX')
</code></pre>
<h2 id="referencias">Referencias<a aria-hidden="true" class="anchor-heading icon-link" href="#referencias"></a></h2>
<ol>
<li><a href="https://sqlparse.readthedocs.io/en/latest/">https://sqlparse.readthedocs.io/en/latest/</a></li>
<li><a href="https://github.com/andialbrecht/sqlparse/blob/master/examples/extract_table_names.py">https://github.com/andialbrecht/sqlparse/blob/master/examples/extract_table_names.py</a></li>
</ol>